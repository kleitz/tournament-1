/**
 * Titon
 * The Mootools UI Framework
 *
 * @copyright	2013
 * @link		http://github.com/titon
 * @license		MIT
 * @authors		Miles Johnson <http://milesj.me>
 * @package		Titon, Module, Tooltip, Tabs
 */

/* Titon.js */
var Titon={version:'1.0.0-beta',options:{prefix:'',activeClass:'active',disabledClass:'disabled',draggableClass:'draggable',draggingClass:'dragging'},msg:{loading:'Loading...',error:'An error has occurred!'},convertType:function(value){value=value.trim();if(value==='true'){value=true;}else if(value==='false'){value=false;}else if(value==='null'){value=null;}else if(isNaN(value)){value=String.from(value);}else{value=Number.from(value);}
return value;},mergeOptions:function(base,options){return Object.merge(Object.clone(base||{}),options||{});},parseOptions:function(data){var options={};if(data){data.split(';').each(function(item){var pieces=item.split(':');if(pieces.length){options[pieces[0]]=Titon.convertType(pieces[1]);}});}
return options;},setup:function(options){Titon.options=Object.merge(Titon.options,options);}};Element.implement({getOptions:function(scope){return Titon.parseOptions(this.get('data-'+scope+'-options'));},fadeIn:function(duration){duration=duration||600;return this.setStyles({display:'',opacity:0}).set('tween',{duration:duration,link:'cancel'}).fade('in');},fadeOut:function(duration,callback){duration=duration||600;if(typeOf(callback)==='null'){callback=function(){this.element.dispose();};}
this.set('tween',{duration:duration,link:'cancel'}).fade('out');if(callback){this.get('tween').chain(callback);}
return this;},setHtml:function(html){if(typeOf(html)==='element'){this.empty().grab(html);}else if(typeOf(html)==='string'&&html.substr(0,1)==='#'){this.set('html',document.getElement(html).get('html'));}else{this.set('html',html);}
return this;}});String.implement({remove:function(chars){if(typeOf(chars)!=='array'){chars=chars.toString().split('');}
return this.replace(new RegExp('['+chars.join('|')+']+','ig'),'');}});

/* Module.js */
Titon.Module=new Class({Implements:[Events,Options],cache:{},element:null,node:null,query:null,options:{template:'',templateFrom:'',parseTemplate:true},initialize:function(options){this.setOptions(options);if(this.options.parseTemplate){var element;if(this.options.templateFrom){element=$(this.options.templateFrom.remove('#'));}
if(!element&&this.options.template){if(element=this.parseTemplate(this.options.template)){element.hide().inject(document.body);}}
if(element){this.element=element;}else{throw new Error('Template failed to parse.');}}},className:function(){return new Hash(window.Titon).keyOf(this.$constructor);},getValue:function(node,query){if(typeOf(query)==='function'){return query(node,this);}
return node.get(query);},isVisible:function(){return(this.element&&this.element.isVisible());},parseTemplate:function(template){if(!template){return null;}
if(typeOf(template)==='element'||instanceOf(template,Element)){return template;}
var element=Elements.from(template);if(element[0]){element=element[0];if(Titon.options.prefix){element.set('class',Titon.options.prefix+element.get('class'));}
return element;}
return null;},reset:function(dispose){if(this.element&&dispose){this.element.dispose();this.element=null;}
this.cache={};this.node=null;return this;},toElement:function(){return this.element;}});

/* modules/Tooltip.js */
Titon.Tooltip=new Class({Extends:Titon.Module,Binds:['_follow','_listen'],elementHead:null,elementBody:null,isClick:false,options:{ajax:false,fade:false,fadeDuration:250,mode:'hover',className:'',position:'topRight',showLoading:true,showTitle:true,getTitle:'title',getContent:'data-tooltip',mouseThrottle:50,xOffset:0,yOffset:0,delay:0,context:null,errorMessage:Titon.msg.error,loadingMessage:Titon.msg.loading,titleElement:'.tooltip-head',contentElement:'.tooltip-body',template:'<div class="tooltip">'+'<div class="tooltip-inner">'+'<div class="tooltip-head"></div>'+'<div class="tooltip-body"></div>'+'</div>'+'<div class="tooltip-arrow"></div>'+'</div>',onHide:null,onShow:null,onPosition:null},customOptions:{},initialize:function(query,options){this.parent(options);this.query=query;this.elementHead=this.element.getElement(this.options.titleElement);this.elementBody=this.element.getElement(this.options.contentElement);if(this.options.className){this.element.addClass(this.options.className);}
this.isClick=(this.options.mode!=='hover');this.disable().enable();},disable:function(){if(this.query){$(this.options.context||document.body).removeEvent((this.isClick?'click':'mouseenter')+':relay('+this.query+')',this._listen);}
return this;},enable:function(){if(this.query){$(this.options.context||document.body).addEvent((this.isClick?'click':'mouseenter')+':relay('+this.query+')',this._listen);}
return this;},hide:function(){if(!this.isVisible()){return;}
if(this.customOptions.className!==this.options.className){this.element.removeClass(this.customOptions.className);}
this.element.removeClass(this.customOptions.position.hyphenate());this.customOptions={};this.node.removeEvents('mousemove');this.node=null;if(this.options.fade){this.element.fadeOut(this.options.fadeDuration,false);}else{this.element.hide();}
this.fireEvent('hide');},show:function(node,content,options,title){if(options===true){options={ajax:true};}else if(!options){options={ajax:this.options.ajax};}
options=Titon.mergeOptions(this.options,options);if(node){options=Titon.mergeOptions(options,node.getOptions('tooltip'));title=title||this.getValue(node,options.getTitle);content=content||this.getValue(node,options.getContent);}
if(!content){return;}
this.node=node;this.customOptions=options;this.element.addClass(options.position.hyphenate()).addClass(options.className);if(node&&!this.isClick){node.removeEvent('mouseleave').addEvent('mouseleave',this.hide.bind(this));}
if(options.ajax){if(this.cache[content]){this._position(this.cache[content],title);}else{new Request({url:content,method:'get',evalScripts:true,onSuccess:function(response){this.cache[content]=response;this._position(response);}.bind(this),onRequest:function(){this.cache[content]=true;if(options.showLoading){this._position(new Element('div.tooltip-loading',{text:this.options.loadingMessage}));}}.bind(this),onFailure:function(){delete this.cache[content];this._position(new Element('div.tooltip-error',{text:this.options.errorMessage}));}.bind(this)}).get();}}else{this._position(content,title);}
this.fireEvent('show');},_follow:function(e){e.stop();this.element.setPosition({x:(e.page.x+10+this.options.xOffset),y:(e.page.y+10+this.options.yOffset)}).fade('show').show();},_listen:function(e,node){e.stop();if(this.isClick){if(this.isVisible()){this.hide();return;}}
this.show(node);},_position:function(content,title){if(content===true){return;}
var options=this.customOptions;if(title&&options.showTitle){this.elementHead.setHtml(title).show();}else{this.elementHead.hide();}
if(content){this.elementBody.setHtml(content).show();}else{this.elementBody.hide();}
if(options.position==='mouse'){var event='mousemove:throttle('+this.options.mouseThrottle+')';this.node.removeEvent(event,this._follow).addEvent(event,this._follow);this.fireEvent('position');}else{var position=options.position,edgeMap={topLeft:'bottomRight',topCenter:'bottomCenter',topRight:'bottomLeft',centerLeft:'centerRight',center:'center',centerRight:'centerLeft',bottomLeft:'topRight',bottomCenter:'topCenter',bottomRight:'topLeft'};this.element.position({relativeTo:this.node,position:position,edge:edgeMap[position]||'topLeft',offset:{x:-options.xOffset,y:-options.yOffset}});window.setTimeout(function(){if(!this.isVisible()){if(this.options.fade){this.element.fadeIn(this.options.fadeDuration);}else{this.element.show();}}
this.fireEvent('position');}.bind(this),this.options.delay||0);}}});Titon.Tooltip.instances={};Titon.Tooltip.factory=function(query,options){if(Titon.Tooltip.instances[query]){return Titon.Tooltip.instances[query];}
var instance=new Titon.Tooltip(query,options);Titon.Tooltip.instances[query]=instance;return instance;};Titon.Tooltip.hide=function(){Object.each(Titon.Tooltip.instances,function(tooltip){tooltip.hide();});};

/* modules/Tabs.js */
Titon.Tabs=new Class({Extends:Titon.Module,Binds:['_listen'],sections:[],tabs:[],previousIndex:0,currentIndex:0,options:{ajax:true,fade:false,fadeDuration:600,mode:'click',activeClass:Titon.options.activeClass,defaultIndex:0,persistState:false,cookie:null,cookieDuration:30,errorMessage:Titon.msg.error,loadingMessage:Titon.msg.loading,tabsElement:'nav a',sectionsElement:'section',template:false,onShow:null},initialize:function(query,options){options.cookie=(options.cookie||query).camelCase();options.templateFrom=query;this.parent(options);this.query=query;this.tabs=this.element.getElements(this.options.tabsElement);this.tabs.each(function(tab,index){tab.set('data-tabs-index',index).removeClass(this.options.activeClass);}.bind(this));this.sections=this.element.getElements(this.options.sectionsElement);this.sections.hide();this.disable().enable();var index=Number.from(Cookie.read('titon.tabs.'+this.options.cookie)||this.options.defaultIndex);this.show(index);},disable:function(){this.tabs.removeEvent((this.options.mode==='click')?'click':'mouseover',this._listen);return this;},enable:function(){this.tabs.addEvent((this.options.mode==='click')?'click':'mouseover',this._listen);return this;},show:function(tab){if(typeOf(tab)==='number'){tab=this.tabs[tab]||null;}
if(!tab){return;}
var className=this.options.activeClass,target=tab.get('data-tabs-index'),url=tab.get('href'),section=this.sections[target];if(url&&!url.contains('#')&&this.options.ajax&&!this.cache[url]){new Request({url:url,method:'get',evalScripts:true,onSuccess:function(response){this.cache[url]=response;section.setHtml(response);}.bind(this),onRequest:function(){section.setHtml(new Element('div.tabs-loading',{text:this.options.loadingMessage}));}.bind(this),onFailure:function(){section.setHtml(new Element('div.tabs-error',{text:this.options.errorMessage}));}.bind(this)}).get();}
this.tabs.removeClass(className);tab.addClass(className);this.sections.hide();if(this.options.fade){section.fadeIn(this.options.fadeDuration)}else{section.show();}
if(this.options.persistState){Cookie.write('titon.tabs.'+this.options.cookie,tab.get('data-tabs-index'),{duration:this.options.cookieDuration});}
this.previousIndex=this.currentIndex;this.currentIndex=tab.get('data-tabs-index');this.fireEvent('show',tab);},_listen:function(e){e.stop();this.show(e.target);}});Titon.Tabs.instances={};Titon.Tabs.factory=function(query,options){if(Titon.Tabs.instances[query]){return Titon.Tabs.instances[query];}
var instance=new Titon.Tabs(query,options);Titon.Tabs.instances[query]=instance;return instance;};